<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>

        .link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5px;
        }

        .node circle {
            fill: #ccc;
            stroke: #fff;
            stroke-width: 1.5px;
        }

        text {
            font: 10px sans-serif;
            pointer-events: none;
        }

    </style>
</head>
<body>
<!--<script src="//d3js.org/d3.v3.min.js"></script>-->
<script src="jquery.js"></script>
<script src="d3v3.js"></script>
<script>

    var context = {
        rootUrl: 'http://localhost:8080',
        projects: null,
        labels: null
    };

    function dedupe(a) {
        return a.filter(function (elem, pos) {
            return a.indexOf(elem) == pos;
        });
    }

    function loadProjectData(callback) {


        var projects = [], labels = [];

        if (context.projects != null && context.labels != null) {
            console.log('the projects and labels have been cached. ' +
                    'Please reload the page to reload the project info from the API');
            callback(context.projects, context.labels);
            return;
        }


        $.getJSON(context.rootUrl + "/project_metadata/projects?callback=?", function (projectIds) {
            console.log('called $.getJSON');
            var defers = projectIds.map(function (projectId) {

                return $.getJSON(context.rootUrl + "/project_metadata/" + projectId + "?callback=?", function (project) {

                    var derivedLabels = project['projectLabels'].map(function (pl) {
                        return pl['label'];
                    });

                    var item = {
                        project: projectId,
                        labels: derivedLabels,
                        repoUrl: project['repoUrl'],
                        aggregator: project['aggregator'],
                        name: project['name'],
                        siteUrl: project['siteUrl'],
                        category: project ['category']
                    };

                    derivedLabels
                            .forEach(function (l) {
                                labels.push(l);
                            });

                    projects.push(item);
                });
            });


            $.when.apply($, defers).then(function () {
                var args = arguments;
                var p = dedupe(projects).filter(function (p) {
                    return p.labels.length > 0;
                });
                var l = dedupe(labels);
                context.labels = l;
                context.projects = p;
                callback(p, l);
            });


        });


    }


    window.addEventListener('load', function () {

        loadProjectData(function (projects, labels) {

            var links = (function () {
                var x = [];
                projects.forEach(function (p) {
                    p['labels'].forEach(function (l) {
                        x.push({target: l, source: p['project']});
                    });
                });
                return dedupe(x);
            })();

            var nodes = {};

            links.forEach(function (link) {
                link.source = nodes[link.source] || (nodes[link.source] = {name: link.source , type : 'label'});
                link.target = nodes[link.target] || (nodes[link.target] = {name: link.target , type : 'project'});
            });

            console.log(nodes)

            // todo: support resizing on screen reorientation
            var width = document.documentElement.clientWidth,
                    height = document.documentElement.clientHeight;

            var force = d3.layout.force()
                    .nodes(d3.values(nodes))
                    .links(links)
                    .size([width, height])
                    .linkDistance(60)
                    .charge(-300)
                    .on("tick", tick)
                    .start();

            var svg = d3.select("body")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

            var link = svg.selectAll(".link")
                    .data(force.links())
                    .enter().append("line")
                    .attr("class", "link");

            var node = svg.selectAll(".node")
                    .data(force.nodes())
                    .enter().append("g")
                    .attr("fill", function (d) {
                        console.log ( d)
                        return  d.type == 'label' ? 'red' : 'green';
                    })
                    .attr("class", "node")
                    .on("mouseover", mouseover)
                    .on("mouseout", mouseout)
                    .call(force.drag);

            node.append("circle")
                    .attr("r", 8);

            node.append("text")
                    .attr("x", 12)
                    .attr("dy", ".35em")
                    .text(function (d) {
                        return d.name;
                    });

            function tick() {
                link
                        .attr("x1", function (d) {
                            return d.source.x;
                        })
                        .attr("y1", function (d) {
                            return d.source.y;
                        })
                        .attr("x2", function (d) {
                            return d.target.x;
                        })
                        .attr("y2", function (d) {
                            return d.target.y;
                        });

                node
                        .attr("transform", function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        });
            }

            function mouseover() {
                d3.select(this).select("circle").transition()
                        .duration(750)
                        .attr("r", 16);
            }

            function mouseout() {
                d3.select(this).select("circle").transition()
                        .duration(750)
                        .attr("r", 8);
            }
        });
    });

</script>
</body>
</html>